# ğŸ”— GREENTRACE - COMPLETE WORKFLOW & CONNECTIVITY

## ğŸ¯ PROJECT FULLY CONNECTED & RUNNING

### âœ… All Components Working
```
Frontend (Next.js 3000) â†â†’ Backend (Express 5000) â†â†’ Database (MongoDB Atlas)
      âœ… Running           âœ… Running                  âœ… Connected
```

---

## ğŸ“Š COMPLETE SYSTEM ARCHITECTURE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GREENTRACE ARCHITECTURE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    FRONTEND LAYER           â”‚
â”‚  (Next.js 16 on :3000)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… React Components          â”‚
â”‚ âœ… TypeScript                â”‚
â”‚ âœ… Tailwind CSS              â”‚
â”‚ âœ… Authentication UI         â”‚
â”‚ âœ… Marketplace UI            â”‚
â”‚ âœ… Knowledge Hub UI          â”‚
â”‚ âœ… Advisory UI               â”‚
â”‚ âœ… Dashboard UI              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTP/REST API Calls
               â”‚ (JSON payloads)
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    API LAYER                â”‚
â”‚  (Express.js on :5000)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Routes:                      â”‚
â”‚ âœ… /auth (Register, Login)   â”‚
â”‚ âœ… /users (Profiles)         â”‚
â”‚ âœ… /products (Marketplace)   â”‚
â”‚ âœ… /orders (Purchases)       â”‚
â”‚ âœ… /advisory (Q&A, Consults) â”‚
â”‚ âœ… /articles (Knowledge)     â”‚
â”‚ âœ… /mandi (Prices)           â”‚
â”‚ âœ… /search (Global)          â”‚
â”‚ âœ… /uploads (Files)          â”‚
â”‚                              â”‚
â”‚ Middleware:                  â”‚
â”‚ âœ… JWT Authentication        â”‚
â”‚ âœ… Error Handling            â”‚
â”‚ âœ… CORS                      â”‚
â”‚ âœ… Rate Limiting             â”‚
â”‚ âœ… Validation                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ Mongoose Queries
               â”‚ (Database operations)
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DATABASE LAYER            â”‚
â”‚  (MongoDB Atlas - Cloud)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Collections:                 â”‚
â”‚ âœ… users (8 fields + role)   â”‚
â”‚ âœ… products (farmer items)   â”‚
â”‚ âœ… orders (transactions)     â”‚
â”‚ âœ… articles (expert content) â”‚
â”‚ âœ… questions (farmer Q)      â”‚
â”‚ âœ… answers (expert A)        â”‚
â”‚ âœ… mandiprice (market data)  â”‚
â”‚ âœ… reviews (ratings)         â”‚
â”‚ âœ… notifications (alerts)    â”‚
â”‚ âœ… tokens (JWT store)        â”‚
â”‚ âœ… searchhistory (logs)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

External Services:
â”œâ”€ ğŸ“§ Email (Gmail SMTP via Nodemailer)
â”œâ”€ ğŸ“± SMS (Twilio)
â”œâ”€ ğŸ“ Storage (AWS S3)
â”œâ”€ ğŸ” Auth (JWT)
â””â”€ ğŸ“Š Maps (Google Maps - optional)
```

---

## ğŸ”„ USER WORKFLOW EXAMPLES

### Workflow 1: New User Registration â†’ Login â†’ Browse Products

```
1. USER SIGNUP (Frontend)
   â””â”€â–º User fills signup form
   â””â”€â–º Clicks "Register" button
   â””â”€â–º Frontend validates form (Zod validation)
   
2. API CALL (Frontend â†’ Backend)
   â””â”€â–º POST /api/v1/auth/register
   â””â”€â–º Body: { email, password, role, name }
   â””â”€â–º Headers: Content-Type: application/json
   
3. BACKEND PROCESSING
   â””â”€â–º Middleware: Validate input
   â””â”€â–º Middleware: Check if email exists
   â””â”€â–º Hash password with bcryptjs
   â””â”€â–º Create User document in MongoDB
   â””â”€â–º Generate JWT tokens (access + refresh)
   
4. RESPONSE (Backend â†’ Frontend)
   â””â”€â–º Status: 201 Created
   â””â”€â–º Body: { success: true, user: {...}, tokens: {...} }
   â””â”€â–º Cookies: Set httpOnly accessToken
   
5. FRONTEND STATE UPDATE
   â””â”€â–º Store user in Context
   â””â”€â–º Store token in secure cookie
   â””â”€â–º Redirect to dashboard
   
6. USER LOGIN (Frontend)
   â””â”€â–º User enters credentials
   â””â”€â–º Clicks "Login"
   â””â”€â–º Frontend validates
   
7. API CALL (Frontend â†’ Backend)
   â””â”€â–º POST /api/v1/auth/login
   â””â”€â–º Body: { email, password }
   
8. BACKEND VERIFICATION
   â””â”€â–º Find user by email in MongoDB
   â””â”€â–º Compare password with bcryptjs
   â””â”€â–º Generate new JWT tokens
   â””â”€â–º Return tokens
   
9. BROWSE PRODUCTS
   â””â”€â–º User clicks "Marketplace"
   â””â”€â–º Frontend loads product list
   
10. API CALL (Frontend â†’ Backend)
    â””â”€â–º GET /api/v1/products
    â””â”€â–º Headers: { Authorization: Bearer <token> }
    
11. BACKEND FETCHES
    â””â”€â–º Verify JWT token (middleware)
    â””â”€â–º Query MongoDB products collection
    â””â”€â–º Apply filters (category, price, location)
    â””â”€â–º Return paginated results
    
12. DISPLAY (Frontend)
    â””â”€â–º Render products with images
    â””â”€â–º Show filters & sorting
    â””â”€â–º Ready for interaction
```

### Workflow 2: Farmer Lists Product â†’ Consumer Purchases

```
FARMER SIDE:
1. Upload Product
   â””â”€â–º POST /api/v1/products
   â””â”€â–º Fields: name, description, price, category, images
   â””â”€â–º Images â†’ AWS S3, reference stored in MongoDB
   
2. Backend Processing
   â””â”€â–º Validate farmer is authenticated
   â””â”€â–º Validate product data
   â””â”€â–º Create Product document
   â””â”€â–º Set status: "pending" â†’ "active" (after admin approval)
   
3. Notification
   â””â”€â–º Send email to admin
   â””â”€â–º Store notification in DB

CONSUMER SIDE:
4. Browse Products
   â””â”€â–º GET /api/v1/products?category=vegetables&minPrice=100
   â””â”€â–º Backend filters & returns matching products
   
5. Add to Cart
   â””â”€â–º Frontend stores in React Context
   â””â”€â–º Cart data stays client-side (no DB yet)
   
6. Checkout
   â””â”€â–º POST /api/v1/orders
   â””â”€â–º Body: { products, shippingAddress, paymentMethod }
   
7. Order Creation
   â””â”€â–º Backend creates Order document
   â””â”€â–º Sets status: "pending"
   â””â”€â–º Reduce product quantity in DB
   
8. Payment (Stripe integration)
   â””â”€â–º Stripe processes payment
   â””â”€â–º Backend confirms payment
   â””â”€â–º Update Order status: "confirmed"
   
9. Notifications
   â””â”€â–º Email sent to farmer (new order)
   â””â”€â–º Email sent to consumer (order confirmed)
   â””â”€â–º Notifications created in DB
   
10. Fulfillment
    â””â”€â–º Farmer updates order status â†’ "shipped"
    â””â”€â–º Consumer notified
    â””â”€â–º Farmer updates status â†’ "delivered"
    â””â”€â–º Order complete
```

### Workflow 3: Expert Publishes Article â†’ Consumer Reads

```
EXPERT SIDE:
1. Write Article
   â””â”€â–º Frontend: Rich text editor component
   â””â”€â–º Fields: title, content, category, tags, cover image
   
2. Publish
   â””â”€â–º POST /api/v1/articles
   â””â”€â–º Body: { title, content, category, tags, coverImage }
   â””â”€â–º Verify user is expert role
   
3. Backend Processing
   â””â”€â–º Validate article data
   â””â”€â–º Create Article document
   â””â”€â–º Set status: "draft" or "published"
   â””â”€â–º Store cover image reference (AWS S3)
   
4. Database Entry
   â””â”€â–º articles collection
   â””â”€â–º Fields: title, content, author (expert ID), 
             category, tags, publishedAt, views, comments

CONSUMER SIDE:
5. Browse Knowledge Hub
   â””â”€â–º GET /api/v1/articles?category=vegetables
   â””â”€â–º Backend returns article list with pagination
   
6. Read Article
   â””â”€â–º GET /api/v1/articles/:articleId
   â””â”€â–º Backend increments view count
   â””â”€â–º Returns article with comments
   
7. Leave Comment
   â””â”€â–º POST /api/v1/articles/:articleId/comments
   â””â”€â–º Body: { text }
   â””â”€â–º Create comment in DB
   â””â”€â–º Notify expert author
   
8. Expert Responds
   â””â”€â–º POST /api/v1/articles/:articleId/comments/:commentId/reply
   â””â”€â–º Notification sent to consumer
```

### Workflow 4: Farmer Asks Question â†’ Expert Answers

```
FARMER SIDE:
1. Ask Question
   â””â”€â–º Frontend: Question form component
   â””â”€â–º POST /api/v1/questions
   â””â”€â–º Body: { title, description, category, attachments }
   
2. Question Stored
   â””â”€â–º MongoDB: questions collection
   â””â”€â–º Status: "open"
   â””â”€â–º Timestamp: created

EXPERT SIDE:
3. View Questions
   â””â”€â–º GET /api/v1/questions?category=vegetables&status=open
   â””â”€â–º Backend returns list
   
4. Provide Answer
   â””â”€â–º POST /api/v1/questions/:questionId/answers
   â””â”€â–º Body: { text, attachments, recommendations }
   
5. Answer Stored
   â””â”€â–º MongoDB: answers collection
   â””â”€â–º Links: questionId, expertId

FARMER SIDE:
6. View Answer
   â””â”€â–º Notification received
   â””â”€â–º Opens answer in app
   â””â”€â–º Can rate quality: upvote/downvote
   â””â”€â–º Can request follow-up
   
7. Rating System
   â””â”€â–º PUT /api/v1/answers/:answerId/rate
   â””â”€â–º Body: { rating: 5 }
   â””â”€â–º Expert reputation updated
```

---

## ğŸ” AUTHENTICATION FLOW (Deep Dive)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              JWT AUTHENTICATION SYSTEM                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

1. LOGIN REQUEST
   â”œâ”€ User submits email + password
   â”œâ”€ Frontend: POST /api/v1/auth/login
   â””â”€ Body: { email: "user@example.com", password: "..." }

2. BACKEND VERIFICATION
   â”œâ”€ Find user by email in MongoDB
   â”œâ”€ Compare password with bcryptjs.compare()
   â””â”€ If match â†’ Generate tokens

3. TOKEN GENERATION
   â”œâ”€ Access Token (JWT)
   â”‚  â”œâ”€ Payload: { userId, role, email }
   â”‚  â”œâ”€ Secret: JWT_SECRET from .env
   â”‚  â”œâ”€ Expiry: 15 minutes (short-lived)
   â”‚  â””â”€ Stored: httpOnly cookie (secure)
   â”‚
   â”œâ”€ Refresh Token (JWT)
   â”‚  â”œâ”€ Payload: { userId }
   â”‚  â”œâ”€ Secret: JWT_SECRET from .env
   â”‚  â”œâ”€ Expiry: 7 days (long-lived)
   â”‚  â””â”€ Stored: httpOnly cookie + MongoDB

4. RESPONSE TO FRONTEND
   â”œâ”€ Status: 200 OK
   â”œâ”€ Body: { success: true, user: {...}, tokens: {...} }
   â”œâ”€ Cookies: Set-Cookie headers (httpOnly, secure, sameSite)
   â””â”€ Frontend stores token in Context

5. AUTHENTICATED REQUESTS
   â”œâ”€ Frontend makes API call
   â”œâ”€ Browser auto-includes cookies in request
   â”œâ”€ OR Header: Authorization: Bearer <access_token>
   â””â”€ Backend middleware verifies token

6. MIDDLEWARE VERIFICATION
   â”œâ”€ Extract token from cookie or header
   â”œâ”€ Verify JWT signature with JWT_SECRET
   â”œâ”€ Check if expired
   â”œâ”€ Extract userId, role from payload
   â”œâ”€ If valid â†’ Add user to req object
   â””â”€ If invalid â†’ Return 401 Unauthorized

7. PROTECTED ROUTE HANDLER
   â”œâ”€ Now has req.user available
   â”œâ”€ Check user.role for authorization
   â”œâ”€ Perform requested operation
   â”œâ”€ Return response
   â””â”€ If auth fails â†’ Return 403 Forbidden

8. TOKEN EXPIRY & REFRESH
   â”œâ”€ Access token expires after 15 minutes
   â”œâ”€ Frontend detects 401 response
   â”œâ”€ Calls refresh endpoint: POST /api/v1/auth/refresh
   â”œâ”€ Backend verifies refresh token
   â”œâ”€ Issues new access token
   â”œâ”€ Frontend retries original request
   â””â”€ User stays logged in

9. LOGOUT
   â”œâ”€ Frontend: POST /api/v1/auth/logout
   â”œâ”€ Backend: Clear cookies, invalidate tokens
   â”œâ”€ Frontend: Clear Context, redirect to login
   â””â”€ User is logged out
```

---

## ğŸ’¾ DATA FLOW EXAMPLES

### Create Product (Complete Data Flow)

```
FRONTEND LAYER:
â”œâ”€ User submits product form
â”œâ”€ Form validation: zod schema validates
â”œâ”€ Create FormData with images
â”œâ”€ API call: POST /api/v1/products
â””â”€ Headers: Content-Type: multipart/form-data, 
            Authorization: Bearer <token>

API LAYER:
â”œâ”€ middleware: authenticate() â†’ Verify JWT
â”œâ”€ middleware: authorize('farmer', 'admin') â†’ Check role
â”œâ”€ middleware: validateProductInput() â†’ Validate data
â”œâ”€ fileUpload middleware:
â”‚  â”œâ”€ Upload images to AWS S3
â”‚  â”œâ”€ Get S3 URLs
â”‚  â””â”€ Add to req.imageUrls
â”œâ”€ Route handler:
â”‚  â”œâ”€ Create new Product instance
â”‚  â”œâ”€ Set: name, description, price, category
â”‚  â”œâ”€ Set: imageUrls (from S3)
â”‚  â”œâ”€ Set: farmerId (from req.user._id)
â”‚  â”œâ”€ Set: status: 'pending'
â”‚  â”œâ”€ Save to MongoDB
â”‚  â””â”€ Return created product

DATABASE LAYER:
â”œâ”€ products collection
â”œâ”€ New document:
â”‚  {
â”‚    _id: ObjectId(),
â”‚    name: "Fresh Tomatoes",
â”‚    description: "Organic, pesticide-free",
â”‚    price: 45,
â”‚    unit: "kg",
â”‚    quantity: 100,
â”‚    category: "vegetables",
â”‚    farmer: ObjectId(farmerId),
â”‚    images: ["https://s3.../img1.jpg", ...],
â”‚    status: "pending",
â”‚    rating: { average: 0, count: 0 },
â”‚    createdAt: Date,
â”‚    updatedAt: Date
â”‚  }
â”œâ”€ Document saved successfully
â””â”€ MongoDB returns _id

RESPONSE:
â”œâ”€ Status: 201 Created
â”œâ”€ Body: { success: true, product: { _id, name, ... } }
â””â”€ Frontend receives and updates UI

NOTIFICATION:
â”œâ”€ Background job (Bull queue)
â”œâ”€ Send email to admin for approval
â”œâ”€ Create notification in DB
â””â”€ Notify via push if enabled
```

---

## ğŸ”„ CONNECTIVITY VERIFICATION MATRIX

| Component | Status | Connection | Response |
|-----------|--------|-----------|----------|
| Frontend | âœ… Running | Next.js on :3000 | Serving |
| Backend | âœ… Running | Express on :5000 | Listening |
| MongoDB | âœ… Connected | Cloud Atlas | Connected |
| Frontendâ†’Backend | âœ… Working | HTTP/REST | 200 OK |
| Backendâ†’MongoDB | âœ… Working | Mongoose | Queries OK |
| Auth System | âœ… Working | JWT + Cookies | Verified |
| API Routes | âœ… Working | All 8 routes | Responding |
| File Upload | âœ… Ready | AWS S3 integration | Ready |
| Email Service | âœ… Ready | Nodemailer/Gmail | Ready |
| SMS Service | âœ… Ready | Twilio | Ready |

---

## âœ¨ FEATURE CONNECTIVITY

### Marketplace Feature Flow
```
Browse Products
  â†“
Frontend â†’ GET /api/v1/products
  â†“
Backend filters from MongoDB products collection
  â†“
Returns with farmer info, images from S3
  â†“
Frontend renders product cards
  â†“
User clicks "Add to Cart"
  â†“
Frontend stores in React Context (client-side)
  â†“
User checks out
  â†“
Frontend â†’ POST /api/v1/orders
  â†“
Backend creates order, links products
  â†“
Sends notification emails
  â†“
Order appears in user dashboard
  â†“
Farmer gets notified
  â†“
Farmer can mark as shipped/delivered
  â†“
Notifications keep both updated
```

### Knowledge Hub Feature Flow
```
Expert writes article
  â†“
Frontend â†’ POST /api/v1/articles
  â†“
Backend stores in MongoDB articles collection
  â†“
Consumers browse knowledge hub
  â†“
Frontend â†’ GET /api/v1/articles?category=X
  â†“
Backend returns filtered results
  â†“
Consumers can read, comment, rate
  â†“
Comments: POST /api/v1/articles/:id/comments
  â†“
Backend stores comments, creates notifications
  â†“
Expert gets notified of new comments
  â†“
Expert can respond
  â†“
Comment thread grows with replies
```

---

## ğŸ¯ SUMMARY: EVERYTHING IS CONNECTED

### âœ… Frontend â†’ Backend âœ…
- All API calls working
- All CORS configured
- Authentication verified
- Token management working

### âœ… Backend â†’ Database âœ…
- MongoDB connection active
- All models working
- CRUD operations functioning
- Data persistence confirmed

### âœ… Frontend â†’ Database (via Backend) âœ…
- Data flows correctly
- Images stored in AWS S3
- Notifications created
- User sessions maintained

### âœ… External Services âœ…
- Email sending ready (Nodemailer)
- SMS ready (Twilio)
- File storage ready (AWS S3)
- All APIs configured

---

## ğŸš€ PRODUCTION READINESS

| Aspect | Status | Details |
|--------|--------|---------|
| Frontend Build | âœ… Ready | `npm run build` works |
| Backend Deploy | âœ… Ready | Can deploy to Heroku/Railway |
| Database | âœ… Production | MongoDB Atlas is managed |
| Security | âœ… Configured | JWT, HTTPS ready, CORS, validation |
| Performance | âœ… Optimized | Connection pooling, compression, caching |
| Error Handling | âœ… Implemented | Global error handlers, validation |
| Logging | âœ… Ready | Winston logs for analysis |
| Rate Limiting | âœ… Active | Protects from abuse |

---

**Status**: âœ… FULLY OPERATIONAL & CONNECTED
**Date**: January 28, 2026
**Next**: Deploy to production or continue development!
